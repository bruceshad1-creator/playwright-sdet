name: External Smoke Tests

on:
  repository_dispatch:
    types: [run-smoke]

permissions:
  contents: read

jobs:
  smoke-test:
    name: smoke-test
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout tests repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Install dependencies
        run: npm ci

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run smoke tests
        run: npx playwright test --grep @smoke

      # ------------------------------------------------------------------
      # Report result back to 'bruceshad.github.io' Repo (PR status check)
      # ------------------------------------------------------------------
      - name: Report status back
        if: always()
        env:
          GH_TOKEN: ${{ secrets.EXTERNAL_TEST_TOKEN }}
          TARGET_REPO: ${{ github.event.client_payload.repo }}
          TARGET_SHA: ${{ github.event.client_payload.sha }}
        run: |
          echo "Reporting status to $TARGET_REPO at $TARGET_SHA"

          if [ "${{ job.status }}" = "success" ]; then
            STATE="success"
            DESC="External smoke tests passed"
          else
            STATE="failure"
            DESC="External smoke tests failed"
          fi

          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            https://api.github.com/repos/$TARGET_REPO/statuses/$TARGET_SHA \
            -d "{
              \"state\": \"$STATE\",
              \"context\": \"external-smoke-tests\",
              \"description\": \"$DESC\"
            }"
